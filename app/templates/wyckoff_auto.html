{% extends "base.html" %}

{% block title %}威科夫量价分析{% endblock %}

{% block extra_css %}
<style>
.advice-buy { color: #28a745; font-weight: bold; }
.advice-sell { color: #dc3545; font-weight: bold; }
.advice-hold { color: #007bff; font-weight: bold; }
.advice-watch { color: #6c757d; }
.result-failed { background-color: #f8f9fa; }
.phase-badge { font-size: 0.85em; }
.event-badge { font-size: 0.8em; margin-right: 2px; }
.progress-container { display: none; margin-bottom: 1rem; }
.price-info { font-size: 0.9em; color: #666; }
.backtest-card { background: #f8f9fa; border-radius: 8px; padding: 1rem; margin-top: 1rem; }
.backtest-card h6 { margin-bottom: 0.75rem; }
.bt-stat { display: inline-block; margin-right: 1rem; margin-bottom: 0.5rem; font-size: 0.875rem; }
.bt-stat .label { color: #6c757d; }
.bt-stat .value { font-weight: 600; }
.bt-stat .value.good { color: #16a34a; }
.bt-stat .value.bad { color: #dc2626; }
.bt-stat .value.neutral { color: #ca8a04; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">威科夫量价分析</h4>
    <div class="d-flex gap-2">
        <button class="btn btn-primary" id="btnAnalyze" onclick="analyzeStocks()">
            分析持仓
        </button>
        <button class="btn btn-outline-info" id="btnBacktest" onclick="backtestStocks()">
            回测验证
        </button>
    </div>
</div>

<div class="progress-container" id="progressContainer">
    <div class="progress">
        <div class="progress-bar progress-bar-striped progress-bar-animated"
             id="analysisProgress" role="progressbar" style="width: 0%">
            0/0
        </div>
    </div>
    <small class="text-muted" id="progressText">正在分析...</small>
</div>

<div class="card">
    <div class="card-body p-0">
        <table class="table table-hover mb-0" id="resultsTable">
            <thead class="table-light">
                <tr>
                    <th>代码</th>
                    <th>名称</th>
                    <th>当前价</th>
                    <th>阶段</th>
                    <th>事件</th>
                    <th>建议</th>
                    <th>支撑/阻力</th>
                </tr>
            </thead>
            <tbody id="resultsBody">
                <tr>
                    <td colspan="7" class="text-center text-muted py-4" id="wyckoffPlaceholder">
                        点击"分析持仓"开始分析
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div id="backtestResultContainer" class="d-none mt-3"></div>

<script>
const POSITIONS = {{ positions | tojson }};

const PHASE_MAP = {
    'accumulation': '吸筹',
    'markup': '上涨',
    'distribution': '派发',
    'markdown': '下跌'
};

const PHASE_CLASS = {
    'accumulation': 'bg-success',
    'markup': 'bg-primary',
    'distribution': 'bg-warning text-dark',
    'markdown': 'bg-danger'
};

const EVENT_MAP = {
    'spring': 'Spring',
    'shakeout': '洗盘',
    'breakout': '突破',
    'utad': 'UTAD'
};

const ADVICE_MAP = {
    'buy': '买入',
    'sell': '卖出',
    'hold': '持有',
    'watch': '观望'
};

function showProgress(current, total) {
    const container = document.getElementById('progressContainer');
    const bar = document.getElementById('analysisProgress');
    const text = document.getElementById('progressText');

    container.style.display = 'block';
    const pct = Math.round(current / total * 100);
    bar.style.width = pct + '%';
    bar.textContent = current + '/' + total;
    text.textContent = current < total ? '正在分析...' : '分析完成';
}

function hideProgress() {
    document.getElementById('progressContainer').style.display = 'none';
}

function renderResults(results) {
    const tbody = document.getElementById('resultsBody');

    if (!results || results.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">无分析结果</td></tr>';
        return;
    }

    tbody.innerHTML = results.map(r => {
        if (r.status !== 'success') {
            return `<tr class="result-failed">
                <td>${r.stock_code}</td>
                <td>${r.stock_name || '-'}</td>
                <td colspan="5" class="text-muted">${r.error_msg || '分析失败'}</td>
            </tr>`;
        }

        const phaseText = PHASE_MAP[r.phase] || r.phase;
        const phaseClass = PHASE_CLASS[r.phase] || 'bg-secondary';

        const eventsHtml = (r.events || []).map(e =>
            `<span class="badge bg-info event-badge">${EVENT_MAP[e] || e}</span>`
        ).join('') || '-';

        const adviceText = ADVICE_MAP[r.advice] || r.advice;
        const adviceClass = 'advice-' + r.advice;

        return `<tr>
            <td>${r.stock_code}</td>
            <td>${r.stock_name || '-'}</td>
            <td>${r.current_price || '-'}</td>
            <td><span class="badge ${phaseClass} phase-badge">${phaseText}</span></td>
            <td>${eventsHtml}</td>
            <td class="${adviceClass}">${adviceText}</td>
            <td class="price-info">${r.support_price || '-'} / ${r.resistance_price || '-'}</td>
        </tr>`;
    }).join('');
}

async function analyzeStocks() {
    const btn = document.getElementById('btnAnalyze');
    btn.disabled = true;
    btn.textContent = '分析中...';

    const stockList = POSITIONS.map(p => ({code: p.code, name: p.name}));

    if (stockList.length === 0) {
        alert('没有持仓数据');
        btn.disabled = false;
        btn.textContent = '分析持仓';
        return;
    }

    showProgress(0, stockList.length);

    // 显示骨架屏
    const tbody = document.getElementById('resultsBody');
    let skeletonHtml = '';
    for (let i = 0; i < Math.min(stockList.length, 8); i++) {
        skeletonHtml += `<tr><td colspan="7"><div class="skeleton-table-row"><div class="skeleton skeleton-cell skeleton-cell-sm"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell skeleton-cell-sm"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell"></div><div class="skeleton skeleton-cell skeleton-cell-sm"></div><div class="skeleton skeleton-cell"></div></div></td></tr>`;
    }
    tbody.innerHTML = skeletonHtml;

    try {
        const response = await fetch('/wyckoff/auto/analyze', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({stock_list: stockList})
        });

        const data = await response.json();
        showProgress(stockList.length, stockList.length);

        if (data.success) {
            renderResults(data.results);
            if (data.failed_count > 0) {
                console.log(`${data.failed_count} 只股票分析失败`);
            }
        } else {
            alert('分析失败: ' + (data.error || '未知错误'));
        }
    } catch (err) {
        console.error('分析请求失败:', err);
        alert('请求失败，请检查网络');
    } finally {
        setTimeout(hideProgress, 1000);
        btn.disabled = false;
        btn.textContent = '分析持仓';
    }
}

async function backtestStocks() {
    const btn = document.getElementById('btnBacktest');
    btn.disabled = true;
    btn.textContent = '回测中...';

    const stockCodes = POSITIONS.map(p => p.code);
    if (stockCodes.length === 0) {
        alert('没有持仓数据');
        btn.disabled = false;
        btn.textContent = '回测验证';
        return;
    }

    try {
        const response = await fetch('/wyckoff/api/backtest/batch', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({stock_codes: stockCodes})
        });
        const data = await response.json();
        renderBacktestResults(data);
    } catch (err) {
        console.error('回测请求失败:', err);
        alert('回测请求失败');
    } finally {
        btn.disabled = false;
        btn.textContent = '回测验证';
    }
}

function renderBacktestResults(data) {
    const container = document.getElementById('backtestResultContainer');
    container.classList.remove('d-none');

    const summary = data.summary || {};
    const wyckoff = data.wyckoff || {};
    const signals = data.signals || {};

    function rateClass(val) {
        if (val === null || val === undefined) return 'neutral';
        return val >= 60 ? 'good' : val >= 40 ? 'neutral' : 'bad';
    }

    function fmtRate(val) {
        return val !== null && val !== undefined ? val + '%' : '-';
    }

    // 整体汇总
    let html = `<div class="backtest-card">
        <h6>回测验证报告</h6>
        <div>
            <span class="bt-stat"><span class="label">覆盖股票:</span> <span class="value">${summary.total_stocks || 0}</span></span>`;

    if (summary.wyckoff_accuracy) {
        Object.entries(summary.wyckoff_accuracy).forEach(([days, acc]) => {
            html += `<span class="bt-stat"><span class="label">威科夫${days}日准确率:</span> <span class="value ${rateClass(acc)}">${fmtRate(acc)}</span></span>`;
        });
    }

    if (summary.signal_buy_win_rate !== null) {
        html += `<span class="bt-stat"><span class="label">买入信号胜率:</span> <span class="value ${rateClass(summary.signal_buy_win_rate)}">${fmtRate(summary.signal_buy_win_rate)}</span></span>`;
    }
    if (summary.signal_sell_win_rate !== null) {
        html += `<span class="bt-stat"><span class="label">卖出信号胜率:</span> <span class="value ${rateClass(summary.signal_sell_win_rate)}">${fmtRate(summary.signal_sell_win_rate)}</span></span>`;
    }

    html += `</div>`;

    // 各股票详情
    const codes = [...new Set([...Object.keys(wyckoff), ...Object.keys(signals)])];
    if (codes.length > 0) {
        html += `<table class="table table-sm mt-2 mb-0">
            <thead><tr><th>代码</th><th>威科夫总数</th><th>10日准确率</th><th>信号总数</th><th>买入胜率(10日)</th><th>卖出胜率(10日)</th></tr></thead><tbody>`;

        codes.forEach(code => {
            const w = wyckoff[code] || {};
            const s = signals[code] || {};
            const wAcc = w.accuracy ? w.accuracy[10] : null;
            const sBuyWr = s.buy && s.buy.win_rates ? s.buy.win_rates[10] : null;
            const sSellWr = s.sell && s.sell.win_rates ? s.sell.win_rates[10] : null;

            html += `<tr>
                <td>${code}</td>
                <td>${w.total || 0}</td>
                <td class="${rateClass(wAcc)}">${fmtRate(wAcc)}</td>
                <td>${s.total || 0}</td>
                <td class="${rateClass(sBuyWr)}">${fmtRate(sBuyWr)}</td>
                <td class="${rateClass(sSellWr)}">${fmtRate(sSellWr)}</td>
            </tr>`;
        });

        html += `</tbody></table>`;
    }

    html += `</div>`;
    container.innerHTML = html;
}
</script>
{% endblock %}
