{% extends "base.html" %}

{% block title %}威科夫参考图{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/wyckoff.css') }}">
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>威科夫参考图</h2>
    <button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#uploadForm">
        上传参考图
    </button>
</div>

<!-- 上传表单 -->
<div class="collapse {% if not references %}show{% endif %}" id="uploadForm">
    <div class="upload-form">
        <form id="referenceForm" enctype="multipart/form-data">
            <div class="row">
                <div class="col-md-4 mb-3">
                    <label class="form-label">选择图片</label>
                    <input type="file" class="form-control" name="file" id="fileInput" accept="image/*" required>
                    <img id="uploadPreview" class="upload-preview">
                </div>
                <div class="col-md-3 mb-3">
                    <label class="form-label">威科夫阶段</label>
                    <select class="form-select" name="phase" required>
                        <option value="">选择阶段</option>
                        <option value="accumulation">吸筹 (Accumulation)</option>
                        <option value="markup">拉升 (Markup)</option>
                        <option value="distribution">派发 (Distribution)</option>
                        <option value="markdown">下跌 (Markdown)</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">描述</label>
                    <input type="text" class="form-control" name="description" placeholder="可选">
                </div>
                <div class="col-md-1 mb-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-success">保存</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- 阶段筛选 -->
<div class="phase-filter">
    <a href="{{ url_for('wyckoff.reference_list') }}" class="btn btn-outline-secondary {% if not current_phase %}active{% endif %}">全部</a>
    <a href="{{ url_for('wyckoff.reference_list', phase='accumulation') }}" class="btn btn-outline-success {% if current_phase == 'accumulation' %}active{% endif %}">吸筹</a>
    <a href="{{ url_for('wyckoff.reference_list', phase='markup') }}" class="btn btn-outline-primary {% if current_phase == 'markup' %}active{% endif %}">拉升</a>
    <a href="{{ url_for('wyckoff.reference_list', phase='distribution') }}" class="btn btn-outline-warning {% if current_phase == 'distribution' %}active{% endif %}">派发</a>
    <a href="{{ url_for('wyckoff.reference_list', phase='markdown') }}" class="btn btn-outline-danger {% if current_phase == 'markdown' %}active{% endif %}">下跌</a>
</div>

<!-- 参考图网格 -->
<div class="wyckoff-grid">
    {% for ref in references %}
    <div class="wyckoff-card" data-id="{{ ref.id }}">
        <img src="{{ url_for('wyckoff.serve_image', filepath=ref.image_path) }}" alt="{{ ref.phase }}" onclick="showImage(this.src)">
        <div class="wyckoff-card-body">
            <div class="wyckoff-card-title">
                <span class="badge phase-badge-{{ ref.phase }}">
                    {% if ref.phase == 'accumulation' %}吸筹
                    {% elif ref.phase == 'markup' %}拉升
                    {% elif ref.phase == 'distribution' %}派发
                    {% elif ref.phase == 'markdown' %}下跌
                    {% endif %}
                </span>
                <button class="btn btn-sm btn-outline-danger" onclick="deleteReference({{ ref.id }})">删除</button>
            </div>
            {% if ref.description %}
            <div class="wyckoff-card-desc">{{ ref.description }}</div>
            {% endif %}
            <div class="wyckoff-card-meta">{{ ref.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
        </div>
    </div>
    {% else %}
    <div class="text-center text-muted py-5">
        <p>暂无参考图，请上传威科夫分析参考图</p>
    </div>
    {% endfor %}
</div>

<!-- 图片放大模态框 -->
<div class="image-modal" id="imageModal" onclick="closeImage()">
    <span class="close-btn">&times;</span>
    <img id="modalImage" src="">
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/wyckoff.js') }}"></script>
<script>
document.getElementById('referenceForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);

    const resp = await fetch('{{ url_for("wyckoff.reference_upload") }}', {
        method: 'POST',
        body: formData
    });

    const data = await resp.json();
    if (data.success) {
        location.reload();
    } else {
        alert(data.error || '上传失败');
    }
});

async function deleteReference(id) {
    if (!confirm('确定删除此参考图？')) return;

    const resp = await fetch(`/wyckoff/reference/${id}`, { method: 'DELETE' });
    const data = await resp.json();

    if (data.success) {
        document.querySelector(`.wyckoff-card[data-id="${id}"]`).remove();
    } else {
        alert(data.error || '删除失败');
    }
}
</script>
{% endblock %}
