{% extends "base.html" %}

{% block title %}å¨ç§‘å¤«åˆ†æ{% if stock_code %} - {{ stock_code }}{% endif %}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/wyckoff.css') }}">
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        å¨ç§‘å¤«åˆ†æ
        {% if stock_code %}<small class="text-muted">- {{ stock_code }}</small>{% endif %}
    </h2>
    <button class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#uploadForm">
        æ–°å»ºåˆ†æ
    </button>
</div>

<!-- ä¸Šä¼ è¡¨å• -->
<div class="collapse" id="uploadForm">
    <div class="upload-form">
        <form id="analysisForm" enctype="multipart/form-data">
            <div class="row">
                <div class="col-md-2 mb-3">
                    <label class="form-label">è‚¡ç¥¨ä»£ç </label>
                    <input type="text" class="form-control" name="stock_code" value="{{ stock_code or '' }}" required>
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label">åˆ†ææ—¥æœŸ</label>
                    <input type="date" class="form-control" name="analysis_date" value="{{ today }}" required>
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label">å¨ç§‘å¤«é˜¶æ®µ</label>
                    <select class="form-select" name="phase" required>
                        <option value="">é€‰æ‹©é˜¶æ®µ</option>
                        <option value="accumulation">å¸ç­¹</option>
                        <option value="markup">æ‹‰å‡</option>
                        <option value="distribution">æ´¾å‘</option>
                        <option value="markdown">ä¸‹è·Œ</option>
                    </select>
                </div>
                <div class="col-md-2 mb-3">
                    <label class="form-label">å…³é”®äº‹ä»¶</label>
                    <select class="form-select" name="event">
                        <option value="">æ— </option>
                        <option value="spring">å¼¹ç°§ Spring</option>
                        <option value="shakeout">éœ‡ä»“ Shakeout</option>
                        <option value="breakout">çªç ´ Breakout</option>
                        <option value="utad">ä¸Šå†²å›è½ UTAD</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">èµ°åŠ¿æˆªå›¾</label>
                    <input type="file" class="form-control" name="file" id="fileInput" accept="image/*" required>
                </div>
            </div>
            <div class="row">
                <div class="col-md-10 mb-3">
                    <label class="form-label">åˆ†æå¤‡æ³¨</label>
                    <textarea class="form-control" name="notes" rows="2" placeholder="å¯é€‰"></textarea>
                </div>
                <div class="col-md-2 mb-3 d-flex align-items-end">
                    <button type="submit" class="btn btn-success w-100">ä¿å­˜åˆ†æ</button>
                </div>
            </div>
            <img id="uploadPreview" class="upload-preview">
        </form>
    </div>
</div>

<!-- åˆ†æè®°å½•åˆ—è¡¨ -->
{% if analyses %}
<div class="analysis-list">
    {% for analysis in analyses %}
    <div class="analysis-card" data-id="{{ analysis.id }}">
        <div class="analysis-card-header">
            <div>
                <strong>{{ analysis.stock_code }}</strong>
                <span class="text-muted ms-2">{{ analysis.analysis_date.strftime('%Y-%m-%d') }}</span>
                <span class="badge phase-badge-{{ analysis.phase }} ms-2">
                    {% if analysis.phase == 'accumulation' %}å¸ç­¹
                    {% elif analysis.phase == 'markup' %}æ‹‰å‡
                    {% elif analysis.phase == 'distribution' %}æ´¾å‘
                    {% elif analysis.phase == 'markdown' %}ä¸‹è·Œ
                    {% endif %}
                </span>
                {% if analysis.event %}
                <span class="event-badge event-{{ analysis.event }}">
                    {% if analysis.event == 'spring' %}ğŸŒ± Spring
                    {% elif analysis.event == 'shakeout' %}ğŸ’¥ Shakeout
                    {% elif analysis.event == 'breakout' %}ğŸš€ Breakout
                    {% elif analysis.event == 'utad' %}âš ï¸ UTAD
                    {% endif %}
                </span>
                {% endif %}
            </div>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteAnalysis({{ analysis.id }})">åˆ é™¤</button>
        </div>
        <div class="analysis-card-content">
            <img class="analysis-card-image" src="{{ url_for('wyckoff.serve_image', filepath=analysis.image_path) }}" onclick="showImage(this.src)">
            <div class="analysis-card-info">
                {% if analysis.notes %}
                <div class="analysis-card-notes">{{ analysis.notes }}</div>
                {% endif %}
                <div class="text-muted mt-2" style="font-size: 12px;">
                    åˆ›å»ºäº {{ analysis.created_at.strftime('%Y-%m-%d %H:%M') }}
                    {% if analysis.updated_at and analysis.updated_at != analysis.created_at %}
                    | æ›´æ–°äº {{ analysis.updated_at.strftime('%Y-%m-%d %H:%M') }}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="text-center text-muted py-5">
    <p>æš‚æ— åˆ†æè®°å½•</p>
    <p>ç‚¹å‡»"æ–°å»ºåˆ†æ"æ·»åŠ ç¬¬ä¸€æ¡åˆ†æè®°å½•</p>
</div>
{% endif %}

<!-- å›¾ç‰‡æ”¾å¤§æ¨¡æ€æ¡† -->
<div class="image-modal" id="imageModal" onclick="closeImage()">
    <span class="close-btn">&times;</span>
    <img id="modalImage" src="">
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/wyckoff.js') }}"></script>
<script>
document.getElementById('analysisForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const formData = new FormData(this);

    const resp = await fetch('{{ url_for("wyckoff.analysis_save") }}', {
        method: 'POST',
        body: formData
    });

    const data = await resp.json();
    if (data.success) {
        location.reload();
    } else {
        alert(data.error || 'ä¿å­˜å¤±è´¥');
    }
});

async function deleteAnalysis(id) {
    if (!confirm('ç¡®å®šåˆ é™¤æ­¤åˆ†æè®°å½•ï¼Ÿ')) return;

    const resp = await fetch(`/wyckoff/analysis/${id}`, { method: 'DELETE' });
    const data = await resp.json();

    if (data.success) {
        document.querySelector(`.analysis-card[data-id="${id}"]`).remove();
    } else {
        alert(data.error || 'åˆ é™¤å¤±è´¥');
    }
}
</script>
{% endblock %}
